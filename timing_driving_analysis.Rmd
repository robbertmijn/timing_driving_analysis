---
title: "driving experiment analysis"
author: "Robbert van der Mijn"
date: "9/22/2021"
output: 
  html_document: 
    toc: yes
    keep_md: yes
    toc_float: 
        collapsed: false
        smooth_scroll: true
editor_options: 
  chunk_output_type: console
---

```{r setup, echo=FALSE}
source("functions_preprocessing_driving_timing.R")
load("20220623135303_timing_driving.rdata") # available on request

# prepping variables for visualisation
timing_dat[, barcol := ifelse(offsettime %between% c(0, 2), "red", "pink")]
timing_dat[offsettime %between% c(12, 14), barcol := "lightgreen"]
timing_dat[narrow == F, barcol := "gray"]
timing_dat[narrow == F, onsettime := 6]
timing_dat[narrow == F, offsettime := 16]
```

# Descriptive figures

## Timing

Point in time when response is required (offset time) relative to start of narrow

```{r}
timing_meandat <- timing_dat[outlier == 0, .(rt = mean(rt)), by = .(onsettime, offsettime, barcol, pp_id)]
ggplot() +
  geom_violin(data = timing_meandat, aes(fill = barcol, color = barcol, x = offsettime, y = rt, gr = as.factor(offsettime)), alpha = .5) +
  scale_color_identity(guide = "legend", labels = c("No narrow", "Narrow cleared", "Narrow during interval", "Narrow during response")) +
  scale_fill_identity(guide = "legend", labels = c("No narrow", "Narrow cleared", "Narrow during interval", "Narrow during response")) +
  scale_x_continuous(breaks = seq(-2, 14, by = 2)) +
  labs(x = "Time (s)", y = "Response time", fill = NULL, color = NULL)
```

## Driving

Change in velocity since baseline period (-5 to -3 seconds before onset of the narrow). Comparing trials in which there was no narrow present (so baselining is a bit arbitrary) and trials in which it was.

```{r}
driving_meandat <- driving_dat[t_onset %between% c(-2, 14), .(velocity.bl = mean(velocity.bl)), by = .(t_onset, narrow, pp_id)]
driving_meandat <- driving_meandat[, .(velocity.bl = mean(velocity.bl), se = sd(velocity.bl)/sqrt(.N)), by = .(t_onset, narrow)]
ggplot(driving_meandat, aes(x = t_onset, y = velocity.bl, color = narrow)) +
  geom_line() +
  geom_ribbon(data = driving_meandat, aes(ymin = velocity.bl - se, ymax = velocity.bl + se, fill = narrow, x = t_onset), color = NA, alpha = .1) +
  scale_color_manual(values = c("lightgreen", "red")) +
  scale_fill_manual(values = c("lightgreen", "red")) +
  labs(x = "Time since narrow onset (s)", y = "Mean relative speed change (km/h)")
```

## Combined

Combining the two figures

```{r}
timing_meandat[, rt.sc := rescale(rt, to = range(driving_meandat$velocity.bl))]
driving_meandat[, velocity.bl.sc := rescale(velocity.bl, to = range(timing_meandat$rt))]

ggplot() +
  geom_line(data = driving_meandat, aes(x = t_onset, y = velocity.bl.sc, linetype = narrow)) +
  geom_violin(data = timing_meandat, aes(fill = barcol, color = barcol, x = offsettime, y = rt, group = as.factor(offsettime)), alpha = .5) +
  scale_color_identity(guide = "legend", labels = c("No narrow", "Narrow cleared", "Narrow during interval", "Narrow during response")) +
  scale_fill_identity(guide = "legend", labels = c("No narrow", "Narrow cleared", "Narrow during interval", "Narrow during response")) +
  scale_linetype_discrete(labels = c("Narrow absent", "Narrow present")) +
  scale_x_continuous(breaks = seq(-2, 14, by = 2)) +
  scale_y_continuous(sec.axis = sec_axis(~ (. - min(timing_meandat$rt)) / diff(range(timing_meandat$rt)) * diff(range(driving_meandat$velocity.bl)) + min(driving_meandat$velocity.bl), name = "Mean relative speed change (km/h)")) +
  labs(x = "Time (s)", y = "Response time (s, violin plots)", linetype = NULL, fill = NULL, color = NULL)
```

# LMERS

## Timing

### Narrow yes of no

Estimate Linear Mixed Effects Regression model with Response Time (```rt```) as dependent continuous variable and ```pp_id``` as random factor. Compare intercept only model to model that includes whether or not that trial included a narrow (```narrow```) by estimating BF (Wagemakers, 2007).

```{r}
tm0 <- lmer(data = timing_dat, rt ~ 1 + (1|pp_id))
tm1 <- lmer(data = timing_dat, rt ~ narrow + (1|pp_id))
exp((BIC(tm0) - BIC(tm1))/2)
summary(tm1)
plotdat <- data.table(data.frame(emmeans(tm1, 
                                         specs = c("narrow"),
                                         at = list(narrow = c(TRUE, FALSE)),
                                         type = "response")))
ggplot(plotdat, aes(x = narrow, y = emmean)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = .3)
```

BF of 35 indicates the presence of a narrow has an effect on rt. With a narrow present, rts are 260 ms shorter (2.6%). 

### Per offset time 

Offset time relative to start of narrow

```{r}
offsetdat <- timing_dat[narrow == T & outlier == 0]
offsetdat$offsettime.f <- factor(as.character(offsetdat$offsettime), levels = as.character(seq(-2, 14, by = 2)))
tm0 <- lmer(data = offsetdat, rt ~ 1 + (1|pp_id))
tm2 <- lmer(data = offsetdat, rt ~ offsettime.f + (1|pp_id))
exp((BIC(tm0) - BIC(tm2))/2)
emmean <- emmeans(tm2, 
                  specs = c("offsettime.f"),
                  at = list(offsettime.f = levels(offsetdat$offsettime.f)),
                  type = "response")
plotdat <- data.table(data.frame(emmean))
ggplot(plotdat, aes(x = offsettime.f, y = emmean)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = .3)
```

BF < 0.001 indicates no difference between conditions. If anything, when response is require 8 seconds after they've entered the narrow (i.e., they've been out of it for 5), they respond a bit faster. 

*TODO: Decide if we want to post hoc test on 8 after seeing this. *

### Initial hypothesis

Re-code variables to compare the mean of offset time 0 and 2 to the mean of the rest

```{r}
hypothdat <- timing_dat[narrow == T & outlier == 0]
hypothdat[, in_narrow := ifelse(offsettime %in% c(0, 2), TRUE, FALSE)]
tm0 <- lmer(data = hypothdat, rt ~ 1 + (1|pp_id))
tm1 <- lmer(data = hypothdat, rt ~ in_narrow + (1|pp_id))
exp((BIC(tm0) - BIC(tm1))/2)
hypothemmean <- emmeans(tm1, 
                        specs = c("in_narrow"),
                        at = list(in_narrow = c(TRUE, FALSE)),
                        type = "response")
plotdat <- data.table(data.frame(hypothemmean))
ggplot(plotdat, aes(x = in_narrow, y = emmean)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = .3)
```

BF = 0.013, thus no effect of having to respond while in narrow

## Driving

```{r}
driving_windat <- driving_dat[t_onset %between% c(0, 3), .(velocity.bl = mean(velocity.bl)), by = .(pp_id, trial, narrow)]
dm0 <- lmer(data = driving_windat, velocity.bl ~ 1 + (1|pp_id))
dm1 <- lmer(data = driving_windat, velocity.bl ~ narrow +  (1|pp_id))
exp((BIC(dm0) - BIC(dm1))/2)
summary(dm1)
plotdat <- data.table(data.frame(emmeans(dm1, 
                                         specs = c("narrow"),
                                         at = list(narrow = c(TRUE, FALSE)),
                                         type = "response")))
ggplot(plotdat, aes(x = narrow, y = emmean)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = .3)
```

BF of > 1000 indicates the presence of a narrow has an effect on speed. With a narrow present, speed decreases by 0.88 km/h. 

## Combined

```{r}
combdat <- merge(driving_windat, 
                 offsetdat, by = c("pp_id", "trial", "narrow"))
cm0 <- lmer(data = combdat, rt ~ 1 + (1|pp_id))
cm1 <- lmer(data = combdat, rt ~ velocity.bl * offsettime.f + (1|pp_id))
exp((BIC(cm0) - BIC(cm1))/2)
summary(cm1)
quants <- quantile(driving_windat$velocity.bl, p = c(.05, .95))
seq(quants[1], quants[2], length.out = 5)
plotdat <- data.table(data.frame(emmeans(cm1, 
                                         specs = c("velocity.bl", "offsettime.f"),
                                         at = list(velocity.bl = quantile(driving_windat$velocity.bl, p = c(.1, .25, .5, .75, .9)), offsettime.f = levels(offsetdat$offsettime.f)),
                                         type = "response")))
ggplot(plotdat, aes(x = offsettime.f, y = emmean)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = .3) +
  facet_wrap(~velocity.bl)
```

BF < 0.0001 indicates no interaction between offset time and speed. 5 plots for the .1, .25, .5, .75 and .9 quantiles of velocities.